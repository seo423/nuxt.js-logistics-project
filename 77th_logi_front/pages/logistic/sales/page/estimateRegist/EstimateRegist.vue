<template>
  <div>
    <VCard class="mb-6" title="Í≤¨Ï†Å Îì±Î°ù">
      <VContainer>
        <VForm @submit.prevent="() => {}">
          <VRow>
            <!-- üëâ Í≤¨Ï†Å Îì±Î°ù -->
            <VCol cols="24" md="2" offset-md="">
              <VDialog v-model="isestimateDialogVisible" width="500" persistent>
                <!-- Í≤¨Ï†Å Îì±Î°ù Î≤ÑÌäº -->
                <template #activator="{ props }">
                  <VBtn v-bind="props"> Ï∂îÍ∞Ä </VBtn>
                </template>

                <!-- Îã§Ïù¥ÏñºÎ°úÍ∑∏ Îã´Í∏∞ Î≤ÑÌäº -->
                <DialogCloseBtn
                  @click="isestimateDialogVisible = !isestimateDialogVisible"
                />

                <!-- Í≤¨Ï†ÅÎì±Î°ù Îã§Ïù¥ÏñºÎ°úÍ∑∏ ÌÖåÏù¥Î∏î -->
                <VCard title="Í≤¨Ï†ÅÎì±Î°ù">
                  <VContainer>
                    <VCol>
                      <AppSelect
                        class="mb-3"
                        label="Í±∞ÎûòÏ≤òÎ™Ö"
                        :items="infodata"
                        v-model="selectedCustomer"
                        item-text="title"
                        item-value="value"
                        variant="outlined"
                      />
                      <AppDateTimePicker
                        class="mb-3"
                        v-model="esDate"
                        label="Í≤¨Ï†ÅÏùºÏûê"
                        placeholder="YYYY-MM-DD"
                        :readonly="true"
                      />
                      <AppDateTimePicker
                        class="mb-3"
                        v-model="efDate"
                        label="Ïú†Ìö®ÏùºÏûê"
                        placeholder="YYYY-MM-DD"
                      />
                      <AppTextField
                        class="mb-3"
                        label="Í≤¨Ï†ÅÎã¥ÎãπÏûê"
                        v-model="user"
                        readonly
                        variant="outlined"
                      />
                      <AppTextField
                        class="mb-3"
                        label="Í≤¨Ï†ÅÏöîÏ≤≠Ïûê"
                        v-model="user"
                        readonly
                        variant="outlined"
                      />
                      <AppTextField
                        class="mb-3"
                        label="ÎπÑÍ≥†"
                        v-model="description"
                        variant="outlined"
                      />
                    </VCol>
                  </VContainer>

                  <VCardText class="d-flex justify-end flex-wrap gap-3">
                    <VBtn variant="tonal" color="secondary" @click="closeModal">
                      Ï∑®ÏÜå
                    </VBtn>
                    <VBtn @click="modifyCom"> ÏûÖÎ†• </VBtn>
                  </VCardText>
                </VCard>
              </VDialog>
              <VBtn @click="addEstimateWithDetails"> Îì±Î°ù </VBtn>
            </VCol>
          </VRow>
        </VForm>

        <!-- üëâ Í≤¨Ï†Å Îì±Î°ù ÌÖåÏù¥Î∏î -->
        <VDataTable
          class="mt-6"
          :headers="headers"
          :items="estimatedata"
          :items-per-page="5"
        />
      </VContainer>
    </VCard>
  </div>

  <!-- Í≤¨Ï†Å ÏÉÅÏÑ∏ -->
  <div>
    <VCard class="mb-6" title="Í≤¨Ï†Å ÏÉÅÏÑ∏">
      <VContainer>
        <VForm @submit.prevent="() => {}">
          <VRow>
            <!-- üëâ Í≤¨Ï†Å ÏÉÅÏÑ∏ Îì±Î°ù -->
            <VCol cols="24" md="2" offset-md="">
              <VDialog
                v-model="isestimatedetailDialogVisible"
                width="500"
                persistent
              >
                <!-- Í≤¨Ï†Å ÏÉÅÏÑ∏ Îì±Î°ù Î≤ÑÌäº -->
                <template #activator="{ props }">
                  <VBtn v-bind="props"> Ï∂îÍ∞Ä </VBtn>
                </template>

                <!-- Îã§Ïù¥ÏñºÎ°úÍ∑∏ Îã´Í∏∞ Î≤ÑÌäº -->
                <DialogCloseBtn
                  @click="
                    isestimatedetailDialogVisible =
                      !isestimatedetailDialogVisible
                  "
                />

                <!-- Í≤¨Ï†ÅÎì±Î°ù Îã§Ïù¥ÏñºÎ°úÍ∑∏ ÌÖåÏù¥Î∏î -->
                <VCard title="Í≤¨Ï†ÅÏÉÅÏÑ∏Îì±Î°ù">
                  <VContainer>
                    <VCol>
                      <AppSelect
                        class="mb-3"
                        label="ÌíàÎ™©ÏΩîÎìú"
                        :items="detailCodes"
                        v-model="selectedCode"
                        @change="onItemCodeChange"
                        variant="outlined"
                      />
                      <AppTextField
                        class="mb-3"
                        label="ÌíàÎ™©Î™Ö"
                        v-model="selectedName"
                        variant="outlined"
                      />
                      <AppTextField
                        class="mb-3"
                        label="Îã®ÏúÑ"
                        value="EA"
                        variant="outlined"
                      />
                      <AppDateTimePicker
                        class="mb-3"
                        v-model="dueDate"
                        label="ÎÇ©Í∏∞Ïùº"
                        placeholder="YYYY-MM-DD"
                      />
                      <AppTextField
                        class="mb-3"
                        label="Í≤¨Ï†ÅÏàòÎüâ"
                        v-model="estimateAmount"
                        variant="outlined"
                      />
                      <AppTextField
                        class="mb-3"
                        label="Í≤¨Ï†ÅÎã®Í∞Ä"
                        v-model="unitPriceOfEstimate"
                        variant="outlined"
                      />
                      <AppTextField
                        class="mb-3"
                        label="Ìï©Í≥ÑÏï°"
                        v-model="sumPriceOfEstimate"
                        variant="outlined"
                      />
                      <AppTextField
                        class="mb-3"
                        label="ÎπÑÍ≥†"
                        v-model="description1"
                        variant="outlined"
                      />
                    </VCol>
                  </VContainer>

                  <VCardText class="d-flex justify-end flex-wrap gap-3">
                    <VBtn
                      variant="tonal"
                      color="secondary"
                      @click="closeModal1"
                    >
                      Ï∑®ÏÜå
                    </VBtn>
                    <VBtn @click="modifyCom1"> ÏûÖÎ†• </VBtn>
                  </VCardText>
                </VCard>
              </VDialog>
            </VCol>
          </VRow>
        </VForm>

        <!-- üëâ Í≤¨Ï†Å ÏÉÅÏÑ∏ Îì±Î°ù ÌÖåÏù¥Î∏î -->
        <VDataTable
          class="mt-6"
          :headers="detailheaders"
          :items="detaildata"
          :items-per-page="5"
        />
      </VContainer>
    </VCard>
  </div>
</template>

<script lang="ts" setup>
import { VDataTable } from "vuetify/labs/VDataTable";
import axios from "axios";
import { watch } from "vue";
import { VAlert } from "vuetify/lib/components/index.mjs";
import { salesStore } from '@/store/logi/sales'
import { companyStore } from "@/store/hr/company";
import { baseStore } from "@/store/logi/base";

// Dialog
const isestimateDialogVisible = ref(false);
const isestimatedetailDialogVisible = ref(false);

const divisionCode = "IT-_I"

// DateTimePicker
const date = ref("");

const infodata = ref([]);
const detailCodes = ref([]);
const selectedName = ref([]);
const detailCodeList = ref([]);

const selectedCustomer = ref("");
const selectedCode = ref("");

const user = "GDW";
const description = ref("");
const estimateAmount = ref(0);
const description1 = ref("");
const unitPriceOfEstimate = ref(0)
const sumPriceOfEstimate = ref(0)

// Í≤¨Ï†Å Îì±Î°ù Îç∞Ïù¥ÌÑ∞ Í∞ùÏ≤¥
const estimatedata = ref([]);
const detaildata = ref([]);

const closeModal = () => {
  isestimateDialogVisible.value = false;
};

const closeModal1 = () => {
  isestimatedetailDialogVisible.value = false;
};

// modifyCom Î©îÏÑúÎìú ÎÇ¥Ïóê Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä Î°úÏßÅ Íµ¨ÌòÑ
const modifyCom = () => {
  // ÏûëÏÑ±Îêú Îç∞Ïù¥ÌÑ∞Î•º Í∞ùÏ≤¥Î°ú Ï†ÄÏû•
  const newData = {
    customerCode: selectedCustomer.value,
    estimateDate: esDate.value,
    effectiveDate: efDate.value,
    personCodeInCharge: user,
    estimateRequester: user,
    description: description.value,
  };

  // estimatedata Î∞∞Ïó¥Ïóê ÏûëÏÑ±Îêú Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä
  estimatedata.value.push(newData);

  // Îã§Ïù¥ÏñºÎ°úÍ∑∏ Îã´Í∏∞
  isestimateDialogVisible.value = false;
};

const modifyCom1 = () => {
  // ÏûëÏÑ±Îêú Îç∞Ïù¥ÌÑ∞Î•º Í∞ùÏ≤¥Î°ú Ï†ÄÏû•
  const newData = {
    itemCode: selectedCode.value,
    itemName: selectedName.value,
    unitOfEstimate: "EA",
    dueDateOfEstimate: dueDate.value, // ÎÇ©Í∏∞Ïùº Ï∂îÍ∞Ä
    estimateAmount: estimateAmount.value,
    description: description1.value,
    unitPriceOfEstimate: unitPriceOfEstimate.value,
    sumPriceOfEstimate: sumPriceOfEstimate.value,
  };

  // detaildata Î∞∞Ïó¥Ïóê ÏûëÏÑ±Îêú Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä
  detaildata.value.push(newData);

  // Îã§Ïù¥ÏñºÎ°úÍ∑∏ Îã´Í∏∞
  isestimatedetailDialogVisible.value = false;
};

// Ïò§Îäò ÎÇ†ÏßúÎ•º Í∞ÄÏ†∏Ïò§Îäî Ìï®Ïàò
const getTodayDate = () => {
  const today = new Date();
  const year = today.getFullYear();
  const month = String(today.getMonth() + 1).padStart(2, "0");
  const day = String(today.getDate()).padStart(2, "0");
  return `${year}-${month}-${day}`;
};

// Ïú†Ìö®ÏùºÏûê
const getEndDate = () => {
  const date = new Date();
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, "0");
  const lastday = new Date(year, month, 0).getDate();
  return `${year}-${month}-${lastday}`;
};

const esDate = ref(getTodayDate()); // Í≤¨Ï†ÅÏùºÏûê
const efDate = ref(getEndDate()); // Ïú†Ìö®ÏùºÏûê
const dueDate = ref(getEndDate()); //ÎÇ©Í∏∞Ïùº

const searchCondition = ref("");
const workplaceCode = ref("");

// Table Columns
const headers = [
  { title: "Í±∞ÎûòÏ≤òÎ™Ö", key: "customerCode" },
  { title: "Í≤¨Ï†ÅÏùºÏûê", key: "estimateDate" },
  { title: "Ïú†Ìö®ÏùºÏûê", key: "effectiveDate" },
  { title: "Í≤¨Ï†ÅÎã¥ÎãπÏûê", key: "personCodeInCharge" },
  { title: "Í≤¨Ï†ÅÏöîÏ≤≠Ïûê", key: "estimateRequester" },
  { title: "ÎπÑÍ≥†", key: "description" },
];

const detailheaders = [
  { title: "ÌíàÎ™©ÏΩîÎìú", key: "itemCode" },
  { title: "ÌíàÎ™©Î™Ö", key: "itemName" },
  { title: "Îã®ÏúÑ", key: "unitOfEstimate" },
  { title: "ÎÇ©Í∏∞Ïùº", key: "dueDateOfEstimate" },
  { title: "Í≤¨Ï†ÅÏàòÎüâ", key: "estimateAmount" },
  { title: "Í≤¨Ï†ÅÎã®Í∞Ä", key: "unitPriceOfEstimate" },
  { title: "Ìï©Í≥ÑÏï°", key: "sumPriceOfEstimate" },
  { title: "ÎπÑÍ≥†", key: "description" },
];

// ÌéòÏù¥ÏßÄ Î°úÎìúÏãú Ïã§Ìñâ
onMounted(async () => {
  infodata.value = await fetchData();
  detailCodes.value = await fetchData1();
});

watch(selectedCode, async (newValue, oldValue) => {
    console.log("selectedCode" + selectedCode);
    await getUnitPrice();
  if (newValue !== oldValue) {
    await onItemCodeChange();
  }
});

watch([estimateAmount, unitPriceOfEstimate], () => {
   sumPriceOfEstimate.value = estimateAmount.value * unitPriceOfEstimate.value
});

// ÏÑ†ÌÉùÎêú Í±∞ÎûòÏ≤òÎ™Ö Î≥ÄÍ≤Ω Ïãú Ìò∏Ï∂úÎêòÎäî Ìï®Ïàò
const onSelectedCustomerChange = (newValue) => {
  selectedCustomer.value = newValue;
};

// Í±∞ÎûòÏ≤òÎ™Ö Î¶¨Ïä§Ìä∏ Í∞ÄÏ†∏Ïò§Í∏∞
// Í≥†Í∞ù Îç∞Ïù¥ÌÑ∞Î•º Í∞ÄÏ†∏Ïò§Îäî Í∏∞Ï°¥ fetchData Ìï®Ïàò
const fetchData = async () => {
  try {
    const searchCondition = "ALL";
    const workplaceCode = "BRC-01";

    await companyStore().GET_CUSTOMER_LIST(searchCondition,workplaceCode)

    const response = companyStore().customerInfo
    
    const customerList = response.map((item: any) => ({
      title: item.customerName, // UIÏóê ÌëúÏãúÎê®
      value: item.customerCode, // Ï†ÄÏû•ÎêòÎäî Í∞í (code)
    }));

    console.log("Í±∞ÎûòÏ≤òÎ™Ö:", customerList);

    infodata.value = customerList;

    return customerList;

  } catch (error) {
    console.error("Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Í∏∞ ÏóêÎü¨:", error);
    return [];
  }
};

// ÌíàÎ™©ÏΩîÎìú Î¶¨Ïä§Ìä∏ Í∞ÄÏ†∏Ïò§Í∏∞
const fetchData1 = async () => {
  try {
    console.log('ÌíàÎ™©ÏΩîÎìú Î¶¨Ïä§Ìä∏ Í∞ÄÏ†∏Ïò§Í∏∞');
    await baseStore().GET_CODELIST(divisionCode)
    detailCodeList.value = baseStore().detailCodeList

    const response = baseStore().detailCodeList
    detailCodes.value = response.map((item: any) => item.detailCode);

    console.log("ÌíàÎ™©ÏΩîÎìú Î™©Î°ù:", detailCodes.value);
    console.log('response124151515', detailCodeList.value)

    return detailCodes.value;
  } catch (error) {
    console.error("ÌíàÎ™©ÏΩîÎìú Î¶¨Ïä§Ìä∏ Í∞ÄÏ†∏Ïò§Í∏∞ ÏóêÎü¨:", error);
    return [];
  }
};

//Ï†úÌíàÎã®Í∞Ä Í∞ÄÏ†∏Ïò§Í∏∞
const getUnitPrice = async () => {
  try{
  await salesStore().GET_UNITPRICE(selectedCode.value)
  unitPriceOfEstimate.value = salesStore().unitPriceOfEstimate;
  }catch (error) {
    console.error("Ï†úÌíàÎã®Í∞Ä Í∞ÄÏ†∏Ïò§Í∏∞ ÏóêÎü¨:", error);
  }
}

// ÌíàÎ™©ÏΩîÎìúÎ•º ÏÑ†ÌÉùÌïòÎ©¥ Ìï¥Îãπ Îç∞Ïù¥ÌÑ∞Ïùò ÌíàÎ™©Î™ÖÏù¥ ÌíàÎ™©Î™ÖÏóê ÎÇòÏò§Í≤å ÌïòÍ∏∞
const onItemCodeChange = () => {

    const selectedItem = detailCodeList.value.find(
      (item: { detailCode: string; }) => item.detailCode === selectedCode.value
    );

    console.log("selectedItem:", selectedItem);

    if (selectedItem) {
      selectedName.value = selectedItem.detailCodeName;
      console.log("ÏÑ†ÌÉùÎêú ÌíàÎ™©Î™Ö:", selectedItem.detailCodeName);
    } else {
      console.log("Ìï¥Îãπ ÌíàÎ™©ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå");
      selectedName.value = ""; // ÌíàÎ™©Î™Ö Ï¥àÍ∏∞Ìôî
    }

};

// Í≤¨Ï†Å Îì±Î°ù Î∞è ÏÉÅÏÑ∏ Îì±Î°ù Ìï®Ïàò
const addEstimateWithDetails = async () => {
  try {
    // ÏÑ†ÌÉùÎêú Í±∞ÎûòÏ≤ò Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
    const customerInfo = infodata.value.find(
      (e) => e.value === selectedCustomer.value
    );

    // ÏÉÅÏÑ∏ Í≤¨Ï†Å Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ
    const detailGridData = detaildata.value.map((e) => ({
      itemCode: e.itemCode,
      itemName: e.itemName,
      unitOfEstimate: "EA",
      dueDateOfEstimate: e.dueDateOfEstimate,
      estimateAmount: e.estimateAmount || 0,
      description: e.description,
      unitPriceOfEstimate: e.unitPriceOfEstimate,
      sumPriceOfEstimate: e.sumPriceOfEstimate,
      status: "INSERT",
    }));

    // ÏÉàÎ°úÏö¥ Í≤¨Ï†Å Îç∞Ïù¥ÌÑ∞ Íµ¨ÏÑ±
    const newEstimateInfo = {
      customerCode: customerInfo.value,
      estimateDate: esDate.value,
      effectiveDate: efDate.value,
      personCodeInCharge: user,
      estimateRequester: user,
      description: description.value,
      estimateDetailTOList: detailGridData,
    };

    console.log("Í≤¨Ï†Å Î∞è ÏÉÅÏÑ∏ Îì±Î°ù Îç∞Ïù¥ÌÑ∞:", newEstimateInfo);

    // API Ìò∏Ï∂úÏùÑ ÏúÑÌï¥ axiosÎ•º ÏÇ¨Ïö©ÌïúÎã§Í≥† Í∞ÄÏ†ïÌï©ÎãàÎã§.
    // const response = await axios.post(
    //   "http://localhost:8282/logi/sales/addNewEstimates",
    //   { newEstimateInfo }
    // );
    await salesStore().ADD_NEW_ESTIMATE(newEstimateInfo)
    alert("Îì±Î°ù ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!");
    // ÏÑ±Í≥µÏ†ÅÏù∏ Ï†úÏ∂ú ÌõÑ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
    estimatedata.value = [];
    detaildata.value = [];
    console.log('isestimatedetailDialogVisible', isestimatedetailDialogVisible)

  } catch (error) {
    console.error("Í≤¨Ï†Å Î∞è ÏÉÅÏÑ∏ Îì±Î°ù Ïã§Ìå®:", error);
    // ÏóêÎü¨ ÏãúÎÇòÎ¶¨Ïò§ Ï≤òÎ¶¨

    // Ïã§Ìå® ÏïåÎ¶º Î©îÏãúÏßÄ
    alert("Îì±Î°ù Ïã§Ìå®! Í≤¨Ï†ÅÏùÑ Îã§Ïãú ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.");
  }
};
</script>
